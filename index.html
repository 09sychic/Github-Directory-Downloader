<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Folder Downloader by @09sychic</title>
  <meta name="description" content="Download any GitHub folder as a ZIP file. Supports private repos with PAT authentication.">
  <meta name="author" content="@09sychic">
  
  <!-- Outfit + JetBrains Mono Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- JSZip Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <style>
    /* ========================================
       CSS Variables & Themes
       ======================================== */
    :root {
      --bg-primary: #050505;
      --bg-secondary: #0A0A0A;
      --bg-tertiary: #111111;
      --bg-elevated: #171717;
      --text-primary: #FAFAFA;
      --text-secondary: #A1A1A1;
      --text-muted: #525252;
      --border-color: #262626;
      --border-hover: #404040;
      
      /* Accent Colors - Solid, no gradients */
      --accent: #8B5CF6;
      --accent-hover: #7C3AED;
      --accent-glow: rgba(139, 92, 246, 0.3);
      --accent-subtle: rgba(139, 92, 246, 0.1);
      
      /* Status Colors */
      --status-yellow: #FBBF24;
      --status-green: #22C55E;
      --status-red: #EF4444;
      --status-orange: #F97316;
      --status-blue: #3B82F6;
      
      --font-family: 'Outfit', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.5);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 40px var(--accent-glow);
    }

    [data-theme="light"] {
      --bg-primary: #FAFAFA;
      --bg-secondary: #F4F4F5;
      --bg-tertiary: #E4E4E7;
      --bg-elevated: #FFFFFF;
      --text-primary: #09090B;
      --text-secondary: #52525B;
      --text-muted: #A1A1AA;
      --border-color: #D4D4D8;
      --border-hover: #A1A1AA;
      --accent-glow: rgba(139, 92, 246, 0.2);
      --accent-subtle: rgba(139, 92, 246, 0.08);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.15);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-family);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
    }

    /* Grid Pattern - No gradient */
    .grid-pattern {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        linear-gradient(var(--border-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
      background-size: 60px 60px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
    }

    /* ========================================
       Animations
       ======================================== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes attention {
      0%, 100% {
        box-shadow: var(--shadow-md);
        border-color: var(--border-color);
      }
      25%, 75% {
        box-shadow: 0 0 0 3px var(--accent-glow), var(--shadow-glow);
        border-color: var(--accent);
      }
    }

    .card.attention {
      animation: attention 1.5s ease-in-out;
    }
    
    /* ========================================
       Main Container
       ======================================== */
    .container {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.6s ease-out;
    }
    
    /* ========================================
       Header
       ======================================== */
    .header {
      text-align: center;
      padding-bottom: 8px;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--accent-subtle);
      border: 1px solid var(--accent);
      border-radius: 100px;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--accent);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .header-badge svg {
      width: 12px;
      height: 12px;
    }
    
    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
      color: var(--accent);
    }
    
    .header p {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .author {
      margin-top: 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .author a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition-fast);
    }

    .author a:hover {
      text-decoration: underline;
    }

    /* ========================================
       Top Actions Bar
       ======================================== */
    .top-actions {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .icon-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .icon-btn svg {
      width: 18px;
      height: 18px;
    }

    /* ========================================
       Keyboard Shortcuts Hint
       ======================================== */
    .keyboard-hints {
      position: fixed;
      bottom: 16px;
      left: 16px;
      display: flex;
      gap: 16px;
      font-size: 0.6875rem;
      color: var(--text-muted);
      z-index: 100;
    }

    .keyboard-hint {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.625rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    /* ========================================
       Card Component
       ======================================== */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
    }

    .card.drag-over {
      border-color: var(--accent);
      background: var(--accent-subtle);
      box-shadow: var(--shadow-glow);
    }

    /* ========================================
       Form Elements
       ======================================== */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-group label svg {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
      transition: var(--transition-fast);
    }

    .input-wrapper input:focus ~ .input-icon {
      color: var(--accent);
    }
    
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      padding-left: 44px;
      font-size: 0.875rem;
      font-family: var(--font-family);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      transition: var(--transition);
      outline: none;
    }
    
    .form-group input::placeholder {
      color: var(--text-muted);
    }
    
    .form-group input:focus {
      border-color: var(--accent);
      background-color: var(--bg-elevated);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }
    
    .form-group .hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .form-group .hint svg {
      width: 12px;
      height: 12px;
    }

    /* Drag & Drop Zone */
    .drop-zone-hint {
      display: none;
      position: absolute;
      inset: 0;
      background: var(--accent-subtle);
      border: 2px dashed var(--accent);
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--accent);
      pointer-events: none;
      animation: pulse 1.5s infinite;
    }

    .card.drag-over .drop-zone-hint {
      display: flex;
    }
    
    /* ========================================
       PAT Section - Redesigned
       ======================================== */
    .pat-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .pat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pat-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      user-select: none;
      transition: var(--transition);
      padding: 8px 12px;
      margin: -8px -12px;
      border-radius: 8px;
    }
    
    .pat-toggle:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .pat-toggle-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-subtle);
      border-radius: 8px;
      color: var(--accent);
    }

    .pat-toggle-icon svg {
      width: 16px;
      height: 16px;
    }
    
    .pat-toggle .chevron {
      width: 16px;
      height: 16px;
      margin-left: auto;
      transition: transform 0.2s ease;
      color: var(--text-muted);
    }
    
    .pat-toggle.expanded .chevron {
      transform: rotate(180deg);
    }

    .pat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.6875rem;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 100px;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    .pat-status.active {
      background: rgba(34, 197, 94, 0.1);
      color: var(--status-green);
    }

    .pat-status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--status-red);
    }

    .pat-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .pat-content {
      display: none;
      flex-direction: column;
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      animation: scaleIn 0.2s ease-out;
    }
    
    .pat-content.visible {
      display: flex;
    }
    
    .pat-input-wrapper {
      position: relative;
    }
    
    .pat-input-wrapper input {
      width: 100%;
      padding: 14px 16px;
      padding-right: 120px;
      font-size: 0.875rem;
      font-family: var(--font-mono);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      transition: var(--transition);
      outline: none;
      letter-spacing: 0.02em;
    }

    .pat-input-wrapper input::placeholder {
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .pat-input-wrapper input:focus {
      border-color: var(--accent);
      background-color: var(--bg-elevated);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }
    
    .pat-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 4px;
    }
    
    .pat-btn {
      padding: 6px 10px;
      font-size: 0.6875rem;
      font-family: var(--font-family);
      font-weight: 600;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pat-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .pat-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-subtle);
    }

    .pat-btn.success {
      border-color: var(--status-green);
      color: var(--status-green);
      background: rgba(34, 197, 94, 0.1);
    }

    .pat-btn.testing {
      border-color: var(--status-yellow);
      color: var(--status-yellow);
      background: rgba(251, 191, 36, 0.1);
    }

    .pat-btn.error {
      border-color: var(--status-red);
      color: var(--status-red);
      background: rgba(239, 68, 68, 0.1);
    }

    /* Input validation states */
    .form-group input.valid {
      border-color: var(--status-green);
    }

    .form-group input.valid:focus {
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .form-group input.invalid {
      border-color: var(--status-red);
    }

    .form-group input.invalid:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .validation-message {
      font-size: 0.75rem;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .validation-message.error {
      color: var(--status-red);
    }

    .validation-message.success {
      color: var(--status-green);
    }

    .validation-message svg {
      width: 12px;
      height: 12px;
    }
    
    .pat-help {
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .pat-help-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .pat-help-title svg {
      width: 16px;
      height: 16px;
      color: var(--status-blue);
    }
    
    .pat-help a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition-fast);
    }
    
    .pat-help a:hover {
      text-decoration: underline;
    }
    
    .pat-help ol {
      margin-top: 12px;
      padding-left: 20px;
      counter-reset: step;
    }
    
    .pat-help li {
      margin-bottom: 8px;
      padding-left: 4px;
    }

    .pat-security {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(34, 197, 94, 0.05);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
      font-size: 0.75rem;
      color: var(--status-green);
    }

    .pat-security svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    
    /* ========================================
       Primary Button - Enhanced (No Gradient)
       ======================================== */
    .btn-primary {
      position: relative;
      width: 100%;
      padding: 16px 24px;
      font-size: 1rem;
      font-family: var(--font-family);
      font-weight: 600;
      background: var(--accent);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: var(--transition);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-primary svg {
      width: 20px;
      height: 20px;
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary.loading {
      background: var(--bg-tertiary);
      border: 1px solid var(--status-yellow);
      color: var(--status-yellow);
    }

    .btn-primary.loading .spinner {
      animation: spin 1s linear infinite;
    }
    
    .btn-primary.success {
      background: var(--status-green);
    }
    
    .btn-primary.error {
      background: var(--status-red);
    }
    
    /* ========================================
       Progress Bar - Enhanced (No Gradient)
       ======================================== */
    .progress-container {
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      animation: scaleIn 0.2s ease-out;
    }
    
    .progress-container.visible {
      display: flex;
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .progress-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .progress-label svg {
      width: 16px;
      height: 16px;
      color: var(--status-yellow);
      animation: spin 2s linear infinite;
    }

    .progress-percent {
      font-size: 0.875rem;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--accent);
    }
    
    .progress-bar {
      height: 8px;
      background-color: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress-fill.complete {
      background: var(--status-green);
    }
    
    .progress-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }
    
    /* ========================================
       Status Message - Enhanced
       ======================================== */
    .status {
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .status svg {
      width: 16px;
      height: 16px;
    }
    
    .status.yellow { color: var(--status-yellow); }
    .status.green { color: var(--status-green); }
    .status.red { color: var(--status-red); }
    .status.orange { color: var(--status-orange); }
    
    /* ========================================
       Process Log - Enhanced
       ======================================== */
    .process-log {
      display: none;
      flex-direction: column;
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      animation: scaleIn 0.2s ease-out;
    }
    
    .process-log.visible {
      display: flex;
    }

    .process-log-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
      font-family: var(--font-family);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .process-log-header svg {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
    }
    
    .process-log-entry {
      color: var(--text-muted);
      line-height: 1.5;
      padding: 2px 0;
      animation: slideIn 0.15s ease-out;
    }
    
    .process-log-entry.info { color: var(--text-secondary); }
    .process-log-entry.step { color: var(--status-yellow); }
    .process-log-entry.success { color: var(--status-green); }
    .process-log-entry.error { color: var(--status-red); }
    .process-log-entry.file { color: var(--text-muted); padding-left: 16px; }
    
    .process-log::-webkit-scrollbar {
      width: 6px;
    }
    
    .process-log::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    
    .process-log::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }
    
    .process-log::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }
    
    /* ========================================
       File Preview - Enhanced
       ======================================== */
    .file-preview {
      display: none;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      animation: scaleIn 0.2s ease-out;
    }
    
    .file-preview.visible {
      display: flex;
    }
    
    .file-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .file-preview-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-preview-header svg {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
    }

    .file-count-badge {
      padding: 2px 8px;
      background: var(--accent-subtle);
      border-radius: 100px;
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .file-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
      word-break: break-all;
      padding: 4px 0;
      animation: slideIn 0.15s ease-out;
    }

    .file-item-icon {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    
    .file-item.fetching { color: var(--status-yellow); }
    .file-item.done { color: var(--status-green); }
    .file-item.error { color: var(--status-red); }
    
    .file-preview::-webkit-scrollbar {
      width: 6px;
    }
    
    .file-preview::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    
    .file-preview::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }
    
    .file-preview::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    /* ========================================
       History Section
       ======================================== */
    .history-section {
      display: none;
    }

    .history-section.visible {
      display: block;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .history-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .history-title svg {
      width: 14px;
      height: 14px;
    }

    .history-clear {
      font-size: 0.6875rem;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: var(--transition-fast);
    }

    .history-clear:hover {
      color: var(--status-red);
      background: rgba(239, 68, 68, 0.1);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }

    .history-item:hover {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .history-item-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: 6px;
      color: var(--text-muted);
    }

    .history-item-icon svg {
      width: 16px;
      height: 16px;
    }

    .history-item-info {
      flex: 1;
      min-width: 0;
    }

    .history-item-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-meta {
      font-size: 0.6875rem;
      color: var(--text-muted);
    }
    
    /* ========================================
       Toast Notifications
       ======================================== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      font-size: 0.875rem;
      color: var(--text-primary);
      pointer-events: auto;
      animation: slideIn 0.3s ease-out;
      max-width: 360px;
    }

    .toast.success {
      border-color: var(--status-green);
    }

    .toast.error {
      border-color: var(--status-red);
    }

    .toast.warning {
      border-color: var(--status-orange);
    }

    .toast-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .toast.success .toast-icon { color: var(--status-green); }
    .toast.error .toast-icon { color: var(--status-red); }
    .toast.warning .toast-icon { color: var(--status-orange); }

    .toast-close {
      margin-left: auto;
      padding: 4px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: var(--transition-fast);
    }

    .toast-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .toast-close svg {
      width: 16px;
      height: 16px;
    }
    
    /* ========================================
       Footer - Enhanced
       ======================================== */
    .footer {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .footer-links {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .footer-links a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: var(--transition-fast);
    }

    .footer-links a:hover {
      color: var(--accent);
    }

    .footer-divider {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--border-color);
    }
    
    /* ========================================
       Responsive Adjustments
       ======================================== */
    @media (max-width: 640px) {
      body {
        padding: 16px;
        justify-content: flex-start;
        padding-top: 80px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .container {
        gap: 20px;
      }

      .keyboard-hints {
        display: none;
      }

      .top-actions {
        top: 12px;
        right: 12px;
      }

      .toast-container {
        left: 16px;
        right: 16px;
        bottom: 16px;
      }

      .toast {
        max-width: 100%;
      }
    }

    /* Focus Visible */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Selection */
    ::selection {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Background Grid Pattern -->
  <div class="grid-pattern" aria-hidden="true"></div>

  <!-- Top Actions -->
  <div class="top-actions">
    <button class="icon-btn" id="themeToggle" title="Toggle theme (T)">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="themeIcon">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
    <button class="icon-btn" id="helpBtn" title="Help (H)">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    </button>
  </div>

  <!-- Keyboard Hints -->
  <div class="keyboard-hints">
    <div class="keyboard-hint">
      <kbd>âŒ˜</kbd><kbd>V</kbd>
      <span>Paste URL</span>
    </div>
    <div class="keyboard-hint">
      <kbd>Enter</kbd>
      <span>Download</span>
    </div>
    <div class="keyboard-hint">
      <kbd>T</kbd>
      <span>Theme</span>
    </div>
  </div>

  <main class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-badge">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
        <span>Open Source Tool</span>
      </div>
      <h1>GitHub Folder Downloader</h1>
      <div class="author">by <a href="https://github.com/09sychic" target="_blank" rel="noopener">@09sychic</a></div>
    </header>
    
    <!-- URL Input Card -->
    <div class="card" id="urlCard">
      <div class="form-group">
        <label for="folderUrl">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
          </svg>
          GitHub Folder URL
        </label>
        <div class="input-wrapper">
          <input 
            type="url" 
            id="folderUrl" 
            placeholder="https://github.com/owner/repo/tree/main/folder"
            autocomplete="off"
            spellcheck="false"
          >
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
          </svg>
          <div class="drop-zone-hint">Drop GitHub URL here</div>
        </div>
        <span class="hint" id="urlHint">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          Paste the full URL to any GitHub folder or drag & drop
        </span>
        <div class="validation-message" id="urlValidation" style="display: none;"></div>
      </div>
    </div>
    
    <!-- PAT Section Card -->
    <div class="card">
      <div class="pat-section">
        <div class="pat-header">
          <div class="pat-toggle" id="patToggle" role="button" tabindex="0" aria-expanded="false">
            <div class="pat-toggle-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </div>
            <span>Private Repository Access</span>
            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="pat-status" id="patStatus">
            <span class="pat-status-dot"></span>
            <span id="patStatusText">Not configured</span>
          </div>
        </div>
        
        <div class="pat-content" id="patContent">
          <div class="pat-input-wrapper">
            <input 
              type="password" 
              id="pat" 
              placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
              autocomplete="off"
              spellcheck="false"
            >
            <div class="pat-actions">
              <button type="button" class="pat-btn" id="testToken" title="Test Token">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="testTokenIcon">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span id="testTokenText">Test</span>
              </button>
              <button type="button" class="pat-btn" id="toggleVisibility" title="Show/Hide">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="visibilityIcon">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              <button type="button" class="pat-btn" id="copyPat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              <button type="button" class="pat-btn" id="clearPat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="pat-help">
            <div class="pat-help-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              How to create a Personal Access Token
            </div>
            <ol>
              <li>Go to <a href="https://github.com/settings/tokens/new?scopes=repo&description=GitHub%20Folder%20Downloader" target="_blank" rel="noopener">GitHub Token Settings</a></li>
              <li>Select <strong>"repo"</strong> scope for private repository access</li>
              <li>Set expiration as needed (90 days recommended)</li>
              <li>Click <strong>"Generate token"</strong> and paste it above</li>
            </ol>
            <div class="pat-security">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <polyline points="9 12 11 14 15 10"></polyline>
              </svg>
              <span>Your token is stored locally in your browser and never sent to any server except GitHub's API.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Downloads History -->
    <div class="card history-section" id="historySection">
      <div class="history-header">
        <div class="history-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Recent Downloads
        </div>
        <button class="history-clear" id="clearHistory">Clear all</button>
      </div>
      <div class="history-list" id="historyList"></div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-header">
        <div class="progress-label">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="2" x2="12" y2="6"></line>
            <line x1="12" y1="18" x2="12" y2="22"></line>
            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
            <line x1="2" y1="12" x2="6" y2="12"></line>
            <line x1="18" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
          </svg>
          <span id="progressLabel">Downloading...</span>
        </div>
        <span class="progress-percent" id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Preparing...</div>
    </div>
    
    <!-- File Preview -->
    <div class="file-preview" id="filePreview">
      <div class="file-preview-header">
        <div class="file-preview-header-left">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>Files</span>
        </div>
        <span class="file-count-badge" id="fileCountBadge">0</span>
      </div>
      <div class="file-list" id="fileList"></div>
    </div>
    
    <!-- Download Button -->
    <button class="btn-primary" id="downloadBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      <span id="downloadBtnText">Download as ZIP</span>
    </button>
    
    <!-- Status Message -->
    <div class="status" id="status"></div>
    
    <!-- Process Log -->
    <div class="process-log" id="processLog">
      <div class="process-log-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="4 17 10 11 4 5"></polyline>
          <line x1="12" y1="19" x2="20" y2="19"></line>
        </svg>
        Process Log
      </div>
      <div id="processLogContent"></div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
      <div class="footer-links">
        <span>Uses GitHub API</span>
        <span class="footer-divider"></span>
        <span>Zipped in browser</span>
        <span class="footer-divider"></span>
        <a href="https://github.com/09sychic" target="_blank" rel="noopener">GitHub</a>
      </div>
    </footer>
  </main>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    /**
     * ================================================
     * GitHub Folder Downloader by @09sychic
     * ================================================
     * Enhanced with:
     * - Fixed private repo downloads (using GitHub API with proper auth)
     * - Parallel downloads for speed (10 concurrent)
     * - No gradients UI
     * - Better error handling
     * ================================================
     */

    // ========================================
    // DOM Elements
    // ========================================
    const folderUrlInput = document.getElementById('folderUrl');
    const patInput = document.getElementById('pat');
    const patToggle = document.getElementById('patToggle');
    const patContent = document.getElementById('patContent');
    const patStatus = document.getElementById('patStatus');
    const patStatusText = document.getElementById('patStatusText');
    const copyPatBtn = document.getElementById('copyPat');
    const clearPatBtn = document.getElementById('clearPat');
    const toggleVisibilityBtn = document.getElementById('toggleVisibility');
    const visibilityIcon = document.getElementById('visibilityIcon');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadBtnText = document.getElementById('downloadBtnText');
    const statusEl = document.getElementById('status');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressLabel = document.getElementById('progressLabel');
    const progressPercent = document.getElementById('progressPercent');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    const fileCountBadge = document.getElementById('fileCountBadge');
    const processLog = document.getElementById('processLog');
    const processLogContent = document.getElementById('processLogContent');
    const urlCard = document.getElementById('urlCard');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const helpBtn = document.getElementById('helpBtn');
    const historySection = document.getElementById('historySection');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const toastContainer = document.getElementById('toastContainer');
    const testTokenBtn = document.getElementById('testToken');
    const testTokenText = document.getElementById('testTokenText');
    const testTokenIcon = document.getElementById('testTokenIcon');
    const urlValidation = document.getElementById('urlValidation');
    const urlHint = document.getElementById('urlHint');

    // ========================================
    // State
    // ========================================
    let isPatVisible = false;
    let downloadHistory = [];
    const PAT_STORAGE_KEY = 'github_folder_downloader_pat';
    const THEME_STORAGE_KEY = 'github_folder_downloader_theme';
    const HISTORY_STORAGE_KEY = 'github_folder_downloader_history';
    const CONCURRENT_DOWNLOADS = 10; // Increased for faster downloads

    // ========================================
    // Initialize
    // ========================================
    function init() {
      // Load saved PAT
      const savedPat = localStorage.getItem(PAT_STORAGE_KEY);
      if (savedPat) {
        patInput.value = savedPat;
        updatePatStatus(true);
      }

      // Load saved theme
      const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      }

      // Load history
      loadHistory();

      // Setup event listeners
      setupEventListeners();
    }

    // ========================================
    // Event Listeners
    // ========================================
    function setupEventListeners() {
      // PAT toggle
      patToggle.addEventListener('click', togglePatSection);
      patToggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          togglePatSection();
        }
      });

      // PAT input changes
      patInput.addEventListener('input', () => {
        const hasPat = patInput.value.trim().length > 0;
        updatePatStatus(hasPat);
        if (hasPat) {
          localStorage.setItem(PAT_STORAGE_KEY, patInput.value.trim());
        } else {
          localStorage.removeItem(PAT_STORAGE_KEY);
        }
      });

      // Toggle visibility
      toggleVisibilityBtn.addEventListener('click', () => {
        isPatVisible = !isPatVisible;
        patInput.type = isPatVisible ? 'text' : 'password';
        visibilityIcon.innerHTML = isPatVisible
          ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>'
          : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      });

      // Copy PAT
      copyPatBtn.addEventListener('click', async () => {
        if (patInput.value) {
          await navigator.clipboard.writeText(patInput.value);
          copyPatBtn.classList.add('success');
          showToast('Token copied to clipboard', 'success');
          setTimeout(() => copyPatBtn.classList.remove('success'), 2000);
        }
      });

      // Clear PAT
      clearPatBtn.addEventListener('click', () => {
        patInput.value = '';
        localStorage.removeItem(PAT_STORAGE_KEY);
        updatePatStatus(false);
        showToast('Token cleared', 'success');
      });

      // Download button
      downloadBtn.addEventListener('click', handleDownload);

      // URL input validation
      folderUrlInput.addEventListener('input', validateUrlInput);
      folderUrlInput.addEventListener('blur', validateUrlInput);

      // Enter key on URL input
      folderUrlInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          if (validateUrlInput()) {
            handleDownload();
          }
        }
      });

      // Test token button
      testTokenBtn.addEventListener('click', testToken);

      // Theme toggle
      themeToggle.addEventListener('click', toggleTheme);

      // Help button
      helpBtn.addEventListener('click', () => {
        // Expand PAT section to show help
        if (!patContent.classList.contains('visible')) {
          togglePatSection();
        }
      });

      // Clear history
      clearHistoryBtn.addEventListener('click', clearHistory);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 't' && !e.ctrlKey && !e.metaKey && document.activeElement !== folderUrlInput && document.activeElement !== patInput) {
          toggleTheme();
        }
        if (e.key === 'h' && !e.ctrlKey && !e.metaKey && document.activeElement !== folderUrlInput && document.activeElement !== patInput) {
          if (!patContent.classList.contains('visible')) {
            togglePatSection();
          }
        }
      });

      // Drag and drop
      urlCard.addEventListener('dragover', (e) => {
        e.preventDefault();
        urlCard.classList.add('drag-over');
      });

      urlCard.addEventListener('dragleave', () => {
        urlCard.classList.remove('drag-over');
      });

      urlCard.addEventListener('drop', (e) => {
        e.preventDefault();
        urlCard.classList.remove('drag-over');
        const text = e.dataTransfer.getData('text');
        if (text && text.includes('github.com')) {
          folderUrlInput.value = text;
          showToast('URL pasted from drag & drop', 'success');
        }
      });
    }

    // ========================================
    // Theme Toggle
    // ========================================
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem(THEME_STORAGE_KEY, newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      themeIcon.innerHTML = theme === 'light'
        ? '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>'
        : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
    }

    // ========================================
    // Toast Notifications
    // ========================================
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '<polyline points="20 6 9 17 4 12"></polyline>',
        error: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>',
        warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>'
      };

      toast.innerHTML = `
        <svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          ${icons[type]}
        </svg>
        <span>${message}</span>
        <button class="toast-close">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `;

      toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.remove();
      });

      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ========================================
    // History Management
    // ========================================
    function loadHistory() {
      try {
        const saved = localStorage.getItem(HISTORY_STORAGE_KEY);
        downloadHistory = saved ? JSON.parse(saved) : [];
        renderHistory();
      } catch {
        downloadHistory = [];
      }
    }

    function addToHistory(url, folderName, fileCount) {
      const item = {
        url,
        name: folderName,
        fileCount,
        timestamp: Date.now()
      };
      
      // Remove duplicates
      downloadHistory = downloadHistory.filter(h => h.url !== url);
      
      // Add to front
      downloadHistory.unshift(item);
      
      // Keep only last 5
      downloadHistory = downloadHistory.slice(0, 5);
      
      localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(downloadHistory));
      renderHistory();
    }

    function renderHistory() {
      if (downloadHistory.length === 0) {
        historySection.classList.remove('visible');
        return;
      }

      historySection.classList.add('visible');
      historyList.innerHTML = downloadHistory.map(item => `
        <div class="history-item" data-url="${item.url}">
          <div class="history-item-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="history-item-info">
            <div class="history-item-name">${item.name}</div>
            <div class="history-item-meta">${item.fileCount} files â€¢ ${formatTimeAgo(item.timestamp)}</div>
          </div>
        </div>
      `).join('');

      // Add click handlers
      historyList.querySelectorAll('.history-item').forEach(el => {
        el.addEventListener('click', () => {
          folderUrlInput.value = el.dataset.url;
          showToast('URL loaded from history', 'success');
        });
      });
    }

    function clearHistory() {
      downloadHistory = [];
      localStorage.removeItem(HISTORY_STORAGE_KEY);
      renderHistory();
      showToast('History cleared', 'success');
    }

    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    // ========================================
    // PAT Section
    // ========================================
    function togglePatSection() {
      const isExpanded = patContent.classList.contains('visible');
      patContent.classList.toggle('visible');
      patToggle.classList.toggle('expanded');
      patToggle.setAttribute('aria-expanded', !isExpanded);
    }

    function updatePatStatus(hasToken, isError = false) {
      patStatus.classList.toggle('active', hasToken && !isError);
      patStatus.classList.toggle('error', isError);
      patStatusText.textContent = isError ? 'Invalid token' : (hasToken ? 'Configured' : 'Not configured');
    }

    function expandPatWithError(suggestToken = true) {
      // Get the PAT card element
      const patCard = patContent.closest('.card');
      
      // Smoothly expand if not already visible
      if (!patContent.classList.contains('visible')) {
        togglePatSection();
      }
      
      // Update status to show it needs attention
      updatePatStatus(false, true);
      
      // Scroll smoothly to PAT section
      setTimeout(() => {
        patCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Add attention animation
        patCard.classList.add('attention');
        setTimeout(() => patCard.classList.remove('attention'), 1500);
        
        // Focus on input after scroll
        setTimeout(() => patInput.focus(), 400);
      }, 100);
      
      // Show helpful suggestion toast
      if (suggestToken) {
        showToast('This might be a private repo. Add a Personal Access Token to access it.', 'warning');
      }
    }

    // ========================================
    // URL Validation
    // ========================================
    function validateUrlInput() {
      const url = folderUrlInput.value.trim();
      
      // Clear validation if empty
      if (!url) {
        folderUrlInput.classList.remove('valid', 'invalid');
        urlValidation.style.display = 'none';
        urlHint.style.display = 'flex';
        return false;
      }

      // Check if it's a valid GitHub URL
      const isValidGitHubUrl = /^https?:\/\/(www\.)?github\.com\/[^\/]+\/[^\/]+/.test(url);
      const parsed = parseGitHubUrl(url);
      
      if (isValidGitHubUrl && parsed) {
        folderUrlInput.classList.remove('invalid');
        folderUrlInput.classList.add('valid');
        urlHint.style.display = 'none';
        urlValidation.style.display = 'flex';
        urlValidation.className = 'validation-message success';
        urlValidation.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Valid: ${parsed.owner}/${parsed.repo}${parsed.path ? '/' + parsed.path : ''}
        `;
        return true;
      } else {
        folderUrlInput.classList.remove('valid');
        folderUrlInput.classList.add('invalid');
        urlHint.style.display = 'none';
        urlValidation.style.display = 'flex';
        urlValidation.className = 'validation-message error';
        urlValidation.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          Invalid GitHub URL format. Use: github.com/owner/repo/tree/branch/folder
        `;
        return false;
      }
    }

    // ========================================
    // Test Token
    // ========================================
    async function testToken() {
      const pat = patInput.value.trim();
      
      if (!pat) {
        showToast('Please enter a token first', 'warning');
        patInput.focus();
        return;
      }

      // Set testing state
      testTokenBtn.classList.remove('success', 'error');
      testTokenBtn.classList.add('testing');
      testTokenText.textContent = 'Testing...';
      testTokenIcon.innerHTML = '<line class="spinner" x1="12" y1="2" x2="12" y2="6"></line><line class="spinner" x1="12" y1="18" x2="12" y2="22"></line><line class="spinner" x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line class="spinner" x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line class="spinner" x1="2" y1="12" x2="6" y2="12"></line><line class="spinner" x1="18" y1="12" x2="22" y2="12"></line><line class="spinner" x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line class="spinner" x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>';
      testTokenBtn.disabled = true;

      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `Bearer ${pat}`
          }
        });

        testTokenBtn.classList.remove('testing');
        testTokenBtn.disabled = false;

        if (response.ok) {
          const user = await response.json();
          testTokenBtn.classList.add('success');
          testTokenText.textContent = 'Valid';
          testTokenIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
          updatePatStatus(true, false);
          showToast(`Token valid! Authenticated as ${user.login}`, 'success');
          
          setTimeout(() => {
            testTokenBtn.classList.remove('success');
            testTokenText.textContent = 'Test';
            testTokenIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
          }, 3000);
        } else {
          testTokenBtn.classList.add('error');
          testTokenText.textContent = 'Invalid';
          testTokenIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
          updatePatStatus(false, true);
          
          if (response.status === 401) {
            showToast('Invalid or expired token', 'error');
          } else if (response.status === 403) {
            showToast('Token lacks required permissions', 'error');
          } else {
            showToast(`Token validation failed: ${response.status}`, 'error');
          }
          
          setTimeout(() => {
            testTokenBtn.classList.remove('error');
            testTokenText.textContent = 'Test';
            testTokenIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
          }, 3000);
        }
      } catch (error) {
        testTokenBtn.classList.remove('testing');
        testTokenBtn.classList.add('error');
        testTokenBtn.disabled = false;
        testTokenText.textContent = 'Error';
        testTokenIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
        showToast('Network error. Check your connection.', 'error');
        
        setTimeout(() => {
          testTokenBtn.classList.remove('error');
          testTokenText.textContent = 'Test';
          testTokenIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
        }, 3000);
      }
    }

    // ========================================
    // Status & Button States
    // ========================================
    function setStatus(message, color = '') {
      statusEl.textContent = message;
      statusEl.className = `status ${color}`;
    }

    function setButtonState(state) {
      downloadBtn.classList.remove('loading', 'success', 'error');
      downloadBtn.disabled = false;

      const icons = {
        default: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
        loading: '<line class="spinner" x1="12" y1="2" x2="12" y2="6"></line><line class="spinner" x1="12" y1="18" x2="12" y2="22"></line><line class="spinner" x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line class="spinner" x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line class="spinner" x1="2" y1="12" x2="6" y2="12"></line><line class="spinner" x1="18" y1="12" x2="22" y2="12"></line><line class="spinner" x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line class="spinner" x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>',
        success: '<polyline points="20 6 9 17 4 12"></polyline>',
        error: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
      };

      const btnIcon = downloadBtn.querySelector('svg');

      switch (state) {
        case 'loading':
          downloadBtn.classList.add('loading');
          downloadBtn.disabled = true;
          downloadBtnText.textContent = 'Downloading...';
          btnIcon.innerHTML = icons.loading;
          break;
        case 'success':
          downloadBtn.classList.add('success');
          downloadBtnText.textContent = 'Download Complete!';
          btnIcon.innerHTML = icons.success;
          break;
        case 'error':
          downloadBtn.classList.add('error');
          downloadBtnText.textContent = 'Download Failed';
          btnIcon.innerHTML = icons.error;
          break;
        default:
          downloadBtnText.textContent = 'Download as ZIP';
          btnIcon.innerHTML = icons.default;
      }
    }

    // ========================================
    // Progress Bar
    // ========================================
    function showProgress(show = true) {
      progressContainer.classList.toggle('visible', show);
      if (!show) {
        progressFill.style.width = '0%';
        progressFill.classList.remove('complete');
        progressPercent.textContent = '0%';
      }
    }

    function updateProgress(current, total, text = '') {
      const percent = Math.round((current / total) * 100);
      progressFill.style.width = `${percent}%`;
      progressPercent.textContent = `${percent}%`;
      progressText.textContent = text || `${current} / ${total} files`;
      
      if (current === total) {
        progressFill.classList.add('complete');
        progressLabel.textContent = 'Complete!';
      }
    }

    // ========================================
    // Process Log
    // ========================================
    function showProcessLog(show = true) {
      processLog.classList.toggle('visible', show);
      if (!show) {
        processLogContent.innerHTML = '';
      }
    }

    function logProcess(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `process-log-entry ${type}`;
      entry.textContent = message;
      processLogContent.appendChild(entry);
      processLog.scrollTop = processLog.scrollHeight;
    }

    function logFile(filePath) {
      const entry = document.createElement('div');
      entry.className = 'process-log-entry file';
      entry.textContent = `â†’ ${filePath}`;
      processLogContent.appendChild(entry);
      processLog.scrollTop = processLog.scrollHeight;
    }

    // ========================================
    // File Preview
    // ========================================
    function showFilePreview(show = true) {
      filePreview.classList.toggle('visible', show);
      if (!show) {
        fileList.innerHTML = '';
        fileCountBadge.textContent = '0';
      }
    }

    function updateFileCount(count) {
      fileCountBadge.textContent = count;
    }

    function addFileToPreview(path, status = '') {
      let fileItem = fileList.querySelector(`[data-path="${CSS.escape(path)}"]`);
      
      if (!fileItem) {
        fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.path = path;
        
        const icon = document.createElement('svg');
        icon.className = 'file-item-icon';
        icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        icon.setAttribute('viewBox', '0 0 24 24');
        icon.setAttribute('fill', 'none');
        icon.setAttribute('stroke', 'currentColor');
        icon.setAttribute('stroke-width', '2');
        icon.innerHTML = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline>';
        
        const text = document.createElement('span');
        text.textContent = path;
        
        fileItem.appendChild(icon);
        fileItem.appendChild(text);
        fileList.appendChild(fileItem);
      }

      fileItem.className = 'file-item';
      if (status) fileItem.classList.add(status);
    }

    // ========================================
    // Parse GitHub URL
    // ========================================
    function parseGitHubUrl(url) {
      const treeMatch = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/tree\/([^\/]+)(?:\/(.*))?/);
      const repoMatch = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/?$/);
      
      if (treeMatch) {
        return {
          owner: treeMatch[1],
          repo: treeMatch[2],
          branch: treeMatch[3],
          path: treeMatch[4] || ''
        };
      } else if (repoMatch) {
        return {
          owner: repoMatch[1],
          repo: repoMatch[2],
          branch: null,
          path: ''
        };
      }
      
      return null;
    }

    // ========================================
    // Fetch with Retry
    // ========================================
    async function fetchWithRetry(url, options, maxRetries = 3) {
      let lastError;
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const response = await fetch(url, options);
          
          if (response.status === 403) {
            const rateLimitReset = response.headers.get('X-RateLimit-Reset');
            if (rateLimitReset) {
              const resetTime = new Date(rateLimitReset * 1000);
              throw new Error(`Rate limited. Resets at ${resetTime.toLocaleTimeString()}`);
            }
          }
          
          return response;
        } catch (error) {
          lastError = error;
          if (attempt < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt - 1) * 500));
          }
        }
      }
      
      throw lastError;
    }

    // ========================================
    // Get Default Branch
    // ========================================
    async function getDefaultBranch(owner, repo, pat = '') {
      const headers = {
        'Accept': 'application/vnd.github.v3+json'
      };
      
      if (pat) {
        headers['Authorization'] = `Bearer ${pat}`;
      }
      
      const response = await fetchWithRetry(`https://api.github.com/repos/${owner}/${repo}`, { headers });
      
      if (!response.ok) {
        if (response.status === 401) throw new Error('AUTH_FAILED');
        if (response.status === 404) throw new Error('NOT_FOUND');
        if (response.status === 403) throw new Error('RATE_LIMITED');
        throw new Error(`API Error: ${response.status}`);
      }
      
      const data = await response.json();
      return data.default_branch;
    }

    // ========================================
    // Fetch GitHub API with Proper Auth
    // ========================================
    async function fetchGitHubApi(endpoint, pat = '') {
      const headers = {
        'Accept': 'application/vnd.github.v3+json'
      };
      
      if (pat) {
        // Use Bearer token format (works for both classic and fine-grained tokens)
        headers['Authorization'] = `Bearer ${pat}`;
      }
      
      const response = await fetchWithRetry(`https://api.github.com${endpoint}`, { headers });
      
      if (!response.ok) {
        if (response.status === 401) throw new Error('AUTH_FAILED');
        if (response.status === 404) throw new Error('NOT_FOUND');
        if (response.status === 403) throw new Error('RATE_LIMITED');
        throw new Error(`API Error: ${response.status}`);
      }
      
      return response.json();
    }

    // ========================================
    // Fetch File Content - FIXED for private repos
    // ========================================
    async function fetchFileContent(owner, repo, branch, filePath, pat = '') {
      const headers = {};
      
      if (pat) {
        // Use GitHub API with raw content accept header for authenticated requests
        headers['Accept'] = 'application/vnd.github.v3.raw';
        headers['Authorization'] = `Bearer ${pat}`;
        
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(filePath).replace(/%2F/g, '/')}?ref=${encodeURIComponent(branch)}`;
        const response = await fetchWithRetry(apiUrl, { headers });
        
        if (!response.ok) {
          // If we get a 404, the file might not exist or token might not have access
          if (response.status === 404) {
            throw new Error(`File not found or no access: ${filePath}`);
          }
          throw new Error(`Failed to fetch file: ${response.status}`);
        }
        
        return response.arrayBuffer();
      } else {
        // For public repos, use raw.githubusercontent.com (faster, no rate limit impact)
        const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${filePath}`;
        const response = await fetchWithRetry(rawUrl, {});
        
        if (!response.ok) {
          throw new Error(`Failed to fetch file: ${response.status}`);
        }
        
        return response.arrayBuffer();
      }
    }

    // ========================================
    // Recursively Fetch All Files using Tree API (Faster!)
    // ========================================
    async function fetchAllFilesUsingTree(owner, repo, branch, path, pat = '') {
      // Use the Git Tree API - much faster than iterating directories
      const endpoint = `/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
      const treeData = await fetchGitHubApi(endpoint, pat);
      
      if (treeData.truncated) {
        logProcess('Warning: Repository too large, some files may be missing', 'warning');
      }
      
      // Filter to only files within the specified path
      const prefix = path ? path + '/' : '';
      const files = treeData.tree
        .filter(item => {
          if (item.type !== 'blob') return false;
          if (!path) return true;
          return item.path.startsWith(prefix) || item.path === path;
        })
        .map(item => ({
          path: item.path,
          sha: item.sha
        }));
      
      return files;
    }

    // ========================================
    // Fallback: Recursively Fetch All Files
    // ========================================
    async function fetchAllFilesRecursive(owner, repo, branch, path, pat = '') {
      const files = [];
      
      async function fetchDirectory(dirPath) {
        const endpoint = `/repos/${owner}/${repo}/contents/${dirPath}${branch ? `?ref=${branch}` : ''}`;
        const contents = await fetchGitHubApi(endpoint, pat);
        
        for (const item of contents) {
          if (item.type === 'file') {
            files.push({
              path: item.path,
              sha: item.sha
            });
          } else if (item.type === 'dir') {
            await fetchDirectory(item.path);
          }
        }
      }
      
      await fetchDirectory(path);
      return files;
    }

    // ========================================
    // Parallel Download Helper (Optimized)
    // ========================================
    async function downloadFilesInParallel(files, owner, repo, branch, pat, basePath, folder, onProgress) {
      let downloaded = 0;
      let failed = 0;
      const total = files.length;
      
      // Process files in batches for parallel downloads
      const batchSize = CONCURRENT_DOWNLOADS;
      
      for (let i = 0; i < files.length; i += batchSize) {
        const batch = files.slice(i, i + batchSize);
        
        const promises = batch.map(async (file) => {
          const relativePath = basePath ? file.path.replace(basePath + '/', '') : file.path;
          addFileToPreview(relativePath, 'fetching');
          
          try {
            const content = await fetchFileContent(owner, repo, branch, file.path, pat);
            folder.file(relativePath, content);
            addFileToPreview(relativePath, 'done');
            logFile(relativePath);
            return { success: true };
          } catch (error) {
            console.error(`Failed to download: ${file.path}`, error);
            addFileToPreview(relativePath, 'error');
            logProcess(`Failed: ${relativePath} - ${error.message}`, 'error');
            return { success: false };
          }
        });
        
        const results = await Promise.all(promises);
        
        results.forEach(result => {
          downloaded++;
          if (!result.success) failed++;
          onProgress(downloaded, total, failed);
        });
      }
      
      return { downloaded, failed };
    }

    // ========================================
    // Main Download Handler
    // ========================================
    async function handleDownload() {
      // Reset state
      setStatus('');
      setButtonState('loading');
      showProgress(true);
      showFilePreview(true);
      showProcessLog(true);
      fileList.innerHTML = '';
      processLogContent.innerHTML = '';
      progressLabel.textContent = 'Downloading...';

      const url = folderUrlInput.value.trim();
      const pat = patInput.value.trim();

      // Validate URL using the validation function
      if (!validateUrlInput()) {
        if (!url) {
          setStatus('Please enter a GitHub folder URL', 'red');
          logProcess('Error: No URL provided', 'error');
          showToast('Please enter a GitHub folder URL', 'error');
        } else {
          setStatus('Invalid GitHub URL format', 'red');
          logProcess('Error: Invalid GitHub URL format', 'error');
          showToast('Please enter a valid GitHub URL', 'error');
        }
        setButtonState('error');
        showProgress(false);
        showFilePreview(false);
        folderUrlInput.focus();
        return;
      }

      // Parse URL
      const parsed = parseGitHubUrl(url);

      const { owner, repo, path } = parsed;
      let branch = parsed.branch;

      logProcess(`Repository: ${owner}/${repo}`, 'info');
      if (pat) logProcess('Using PAT authentication (Bearer token)', 'info');
      
      // Get default branch if not specified
      if (!branch) {
        try {
          logProcess('Detecting default branch...', 'step');
          branch = await getDefaultBranch(owner, repo, pat);
          logProcess(`Default branch: ${branch}`, 'info');
        } catch (error) {
          if (error.message === 'AUTH_FAILED') {
            setStatus('Authentication failed. Check your PAT.', 'red');
            logProcess('Error: Authentication failed - token may be invalid or expired', 'error');
            expandPatWithError();
            setButtonState('error');
            showProgress(false);
            showToast('Authentication failed. Check your token.', 'error');
            return;
          } else if (error.message === 'NOT_FOUND') {
            if (!pat) {
              setStatus('Repository not found. If private, add a PAT.', 'red');
              logProcess('Error: Repository not found - may be private', 'error');
              expandPatWithError();
            } else {
              setStatus('Repository not found or no access.', 'red');
              logProcess('Error: Repository not found or token lacks access', 'error');
            }
            setButtonState('error');
            showProgress(false);
            showToast('Repository not found', 'error');
            return;
          }
          branch = 'main'; // Fallback
          logProcess('Could not detect default branch, using "main"', 'info');
        }
      }

      logProcess(`Branch: ${branch}`, 'info');
      logProcess(`Folder: ${path || '(root)'}`, 'info');
      logProcess('â”€'.repeat(30), 'info');

      const folderName = path ? path.split('/').pop() : repo;

      try {
        // Step 1: Fetch file list using Tree API (faster)
        logProcess('Retrieving directory info (using Tree API)...', 'step');
        setStatus('Fetching file list...', 'yellow');
        updateProgress(0, 100, 'Scanning folder...');

        let files;
        try {
          files = await fetchAllFilesUsingTree(owner, repo, branch, path, pat);
          
          // If path is specified, filter to only files in that path
          if (path) {
            const prefix = path + '/';
            files = files.filter(f => f.path.startsWith(prefix) || f.path === path);
          }
        } catch (error) {
          // Fallback to recursive method if Tree API fails
          logProcess('Tree API failed, using recursive method...', 'info');
          try {
            files = await fetchAllFilesRecursive(owner, repo, branch, path, pat);
          } catch (fallbackError) {
            if (fallbackError.message === 'AUTH_FAILED') {
              setStatus('Authentication failed. Check your PAT.', 'red');
              logProcess('Error: Authentication failed - token may be invalid, expired, or lacks permissions', 'error');
              logProcess('Make sure your token has "repo" scope for private repositories', 'error');
              expandPatWithError();
              setButtonState('error');
              showProgress(false);
              showToast('Authentication failed. Please check your token and permissions.', 'error');
              return;
            } else if (fallbackError.message === 'NOT_FOUND') {
              if (!pat) {
                setStatus('Repository not found. If private, add a PAT.', 'red');
                logProcess('Error: Repository not found - may be private', 'error');
                expandPatWithError();
              } else {
                setStatus('Repository or folder not found.', 'red');
                logProcess('Error: Repository or folder not found, or token lacks access', 'error');
              }
              setButtonState('error');
              showProgress(false);
              showToast('Repository or folder not found', 'error');
              return;
            } else if (fallbackError.message === 'RATE_LIMITED') {
              setStatus('Rate limit exceeded. Add a PAT for more requests.', 'orange');
              logProcess('Error: Rate limit exceeded', 'error');
              expandPatWithError();
              setButtonState('error');
              showProgress(false);
              showToast('Rate limit exceeded. Add a PAT for more requests.', 'warning');
              return;
            }
            throw fallbackError;
          }
        }

        if (files.length === 0) {
          setStatus('No files found in the specified folder', 'orange');
          logProcess('No files found', 'error');
          setButtonState('error');
          showProgress(false);
          showToast('No files found in this folder', 'warning');
          return;
        }

        logProcess(`Found ${files.length} files`, 'success');
        logProcess(`Using ${CONCURRENT_DOWNLOADS} parallel downloads for speed`, 'info');
        logProcess('â”€'.repeat(30), 'info');

        updateFileCount(files.length);
        files.forEach(file => {
          const relativePath = path ? file.path.replace(path + '/', '') : file.path;
          addFileToPreview(relativePath);
        });

        // Step 2: Download files and create ZIP (in parallel)
        logProcess(`Downloading ${files.length} files...`, 'step');
        setStatus('Downloading files...', 'yellow');
        const zip = new JSZip();
        const folder = zip.folder(folderName);

        const { downloaded, failed } = await downloadFilesInParallel(
          files, 
          owner, 
          repo, 
          branch, 
          pat, 
          path, 
          folder,
          (current, total, failedCount) => {
            updateProgress(current, total, `Downloading ${current}/${total}${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
          }
        );

        logProcess('â”€'.repeat(30), 'info');
        logProcess(`Downloaded ${downloaded - failed} files!${failed > 0 ? ` (${failed} failed)` : ''}`, 'success');

        // Step 3: Generate ZIP
        logProcess(`Compressing files...`, 'step');
        setStatus('Creating ZIP file...', 'yellow');
        updateProgress(files.length, files.length, 'Compressing...');

        const zipBlob = await zip.generateAsync({ 
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        }, (metadata) => {
          updateProgress(
            Math.round(metadata.percent), 
            100, 
            `Compressing: ${Math.round(metadata.percent)}%`
          );
        });

        logProcess(`Created ${folderName}.zip`, 'success');

        // Step 4: Trigger download
        logProcess('Starting download...', 'step');
        const downloadUrl = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `${folderName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        // Add to history
        addToHistory(url, folderName, files.length);

        // Success!
        logProcess('â”€'.repeat(30), 'info');
        logProcess('Download complete!', 'success');
        setStatus(`Downloaded ${files.length} files successfully!`, 'green');
        setButtonState('success');
        updateProgress(100, 100, 'Complete!');
        showToast(`Downloaded ${folderName}.zip successfully!`, 'success');

        // Reset button after delay
        setTimeout(() => {
          setButtonState('default');
        }, 3000);

      } catch (error) {
        console.error('Download failed:', error);
        logProcess(`Error: ${error.message}`, 'error');
        setStatus(`Error: ${error.message}`, 'red');
        setButtonState('error');
        showToast(`Download failed: ${error.message}`, 'error');

        setTimeout(() => {
          setButtonState('default');
        }, 3000);
      }
    }

    // Initialize the app
    init();
  </script>
</body>
</html>
